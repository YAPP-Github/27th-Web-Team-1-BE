name: CI - Build and Test

on:
    push:
        branches: [ develop ]
    pull_request:
        branches: [ develop ]
    workflow_dispatch:

env:
    AWS_REGION: ap-northeast-2
    GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2"

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Set up JDK 24
                uses: actions/setup-java@v4
                with:
                    java-version: '24'
                    distribution: 'temurin'

            -   name: Setup Gradle
                uses: gradle/actions/setup-gradle@v4
                with:
                    cache-read-only: ${{ github.ref != 'refs/heads/develop' }}

            -   name: Build & Test
                env:
                    SPRING_PROFILES_ACTIVE: test
                run: ./gradlew build --parallel --build-cache

            -   name: Test Report
                uses: dorny/test-reporter@v1
                if: success() || failure()
                with:
                    name: Test Results
                    path: build/test-results/test/*.xml
                    reporter: java-junit

            -   name: Upload JAR
                if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
                uses: actions/upload-artifact@v4
                with:
                    name: app-jar
                    path: build/libs/*.jar
                    retention-days: 1

    docker:
        needs: build
        if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Download JAR
                uses: actions/download-artifact@v4
                with:
                    name: app-jar
                    path: build/libs

            -   name: Configure AWS credentials
                uses: aws-actions/configure-aws-credentials@v4
                with:
                    aws-access-key-id: ${{ secrets.DEV_AWS_ACCESS_KEY_ID }}
                    aws-secret-access-key: ${{ secrets.DEV_AWS_SECRET_ACCESS_KEY }}
                    aws-region: ${{ env.AWS_REGION }}

            -   name: Login to Amazon ECR
                id: login-ecr
                uses: aws-actions/amazon-ecr-login@v2

            -   name: Set up Docker Buildx
                uses: docker/setup-buildx-action@v3

            -   name: Build & Push Docker Image
                uses: docker/build-push-action@v6
                with:
                    context: .
                    file: infra/Dockerfile
                    platforms: linux/amd64
                    push: true
                    tags: |
                        ${{ steps.login-ecr.outputs.registry }}/${{ secrets.DEV_ECR_REPOSITORY }}:latest
                        ${{ steps.login-ecr.outputs.registry }}/${{ secrets.DEV_ECR_REPOSITORY }}:dev-latest
                        ${{ steps.login-ecr.outputs.registry }}/${{ secrets.DEV_ECR_REPOSITORY }}:${{ github.sha }}
                    cache-from: type=gha
                    cache-to: type=gha,mode=max
